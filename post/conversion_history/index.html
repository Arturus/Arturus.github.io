<!DOCTYPE html>
<html lang="ru">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 3.0.0">
  <meta name="generator" content="Hugo 0.53" />
  <meta name="author" content="Артур Суилин">

  
  
  
  
    
  
  <meta name="description" content="В предыдущей статье мы рассмотрели самую простую модель оценки конверсионности посетителя по параметрам первого посещения. Благодаря использованию SHAP values можно интерпретировать модели любой сложности, поэтому усложним задачу, и оценим конверсионность посетителя, у которого есть история предыдущего взаимодействия с сайтом.
Наличие такой истории даст нам много новой и полезной информации о намерениях посетителя. Но для начала немного разберёмся с микроструктурой данных, в частности с понятиями &ldquo;визит/сессия&rdquo; и &ldquo;переход&rdquo;, которые в современной интернет-аналитике перемешаны друг с другом.">

  
  <link rel="alternate" hreflang="ru" href="https://suilin.ru/post/conversion_history/">

  


  

  

  

  
  
  
  <meta name="theme-color" content="#086377">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" crossorigin="anonymous">
      
    

    

    

  

  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Fira+Sans+Condensed:400,400italic,700|PT+Mono|Fira+Sans|PT+Serif:400,400italic,700">
  

  <link rel="stylesheet" href="/styles.css">
  
  <link rel="stylesheet" href="/css/custom.css">
  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-38480657-1', 'auto');
      
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  
  <link rel="alternate" href="https://suilin.ru/index.xml" type="application/rss+xml" title="Артур Суилин">
  <link rel="feed" href="https://suilin.ru/index.xml" type="application/rss+xml" title="Артур Суилин">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://suilin.ru/post/conversion_history/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@asuilin">
  <meta property="twitter:creator" content="@asuilin">
  
  <meta property="og:site_name" content="Артур Суилин">
  <meta property="og:url" content="https://suilin.ru/post/conversion_history/">
  <meta property="og:title" content="Конверсия и data science IV. Кто владеет прошлым, тот контролирует будущее | Артур Суилин">
  <meta property="og:description" content="В предыдущей статье мы рассмотрели самую простую модель оценки конверсионности посетителя по параметрам первого посещения. Благодаря использованию SHAP values можно интерпретировать модели любой сложности, поэтому усложним задачу, и оценим конверсионность посетителя, у которого есть история предыдущего взаимодействия с сайтом.
Наличие такой истории даст нам много новой и полезной информации о намерениях посетителя. Но для начала немного разберёмся с микроструктурой данных, в частности с понятиями &ldquo;визит/сессия&rdquo; и &ldquo;переход&rdquo;, которые в современной интернет-аналитике перемешаны друг с другом.">
  
  
    
  <meta property="og:image" content="https://suilin.ru/img/me_sq.jpg">
  <meta property="og:locale" content="ru">
  
  <meta property="article:published_time" content="2019-03-18T00:00:00&#43;03:00">
  
  <meta property="article:modified_time" content="2019-03-18T00:00:00&#43;03:00">
  

  

  <meta property="og:type" content="article"/>
<meta name="yandex-verification" content="5753f991e1c3d96c" />
<meta name="google-site-verification" content="5sd_7MZqiS3rR-1B3f-FqUkrWEd92TYr9FNEGkFE14I" />

<script type="text/javascript" >
  (function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
      try {
        w.yaCounter21550249 = new Ya.Metrika2({
          id:21550249,
          clickmap:true,
          trackLinks:true,
          accurateTrackBounce:true,
          webvisor:true
        });
      } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
      s = d.createElement("script"),
      f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = "https://mc.yandex.ru/metrika/tag.js";

    if (w.opera == "[object Opera]") {
      d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
  })(document, window, "yandex_metrika_callbacks2");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/21550249" style="position:absolute; left:-9999px;" alt="" /></div></noscript>



  <title>Конверсия и data science IV. Кто владеет прошлым, тот контролирует будущее | Артур Суилин</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">Артур Суилин</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Переключить навигацию">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        

        <li class="nav-item">
          <a class="nav-link" href="/">
            
            <span>Главная</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/post/">
            
            <span>Блог</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/project/">
            
            <span>Проекты</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#contact">
            
            <span>Контакты</span>
            
          </a>
        </li>

        
        

      

        

        
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">Конверсия и data science IV. Кто владеет прошлым, тот контролирует будущее</h1>

  
  <p class="page-subtitle">Или создаём модели, учитывающие историю посетителя</p>
  

  
    

<div class="article-metadata">

  
  
  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Артур Суилин">
  </span>
  

  <span class="article-date">
    
    <meta content="2019-03-18 00:00:00 &#43;0300 MSK" itemprop="datePublished">
    <time datetime="2019-03-18 00:00:00 &#43;0300 MSK" itemprop="dateModified">
      18.03.2019
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Артур Суилин">
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    21 min read
  </span>
  

  
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/categories/internet-analytics/">Internet analytics</a>
    
  </span>
  
  

  
  

  

</div>

  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      

<p>В <a href="../conversion_factors">предыдущей статье</a> мы рассмотрели самую простую модель оценки
конверсионности посетителя по параметрам первого посещения.
Благодаря использованию <a href="../conversion_factors#shap">SHAP values</a>
можно интерпретировать модели любой сложности, поэтому
усложним задачу, и оценим конверсионность посетителя,
у которого есть история предыдущего взаимодействия с сайтом.</p>

<p>Наличие такой истории даст нам
много новой и полезной информации о намерениях посетителя. Но для
начала немного разберёмся с микроструктурой данных,
в частности с понятиями &ldquo;визит/сессия&rdquo; и &ldquo;переход&rdquo;,
которые в современной интернет-аналитике перемешаны друг с другом.
Работа полученных моделей будет оцениваться на тех же <a href="../conversion_factors/#%D1%81%D0%B0%D0%B9%D1%82%D1%8B">сайтах</a> , что и в предыдущей статье.</p>

<h2 id="что-такое-сессия">Что такое сессия?</h2>

<p>Базовое понятие интернет-аналитики, вокруг которого выстраивается
большинство показателей, которые мы видим в отчётах, это <em>сессия</em> (она же <em>визит</em> в русскоязычной интерпретации).
Под сессией обычно подразумевается интервал времени, в котором
не было более чем получасовых пауз в активности посетителя. То есть
посетитель пришёл на сайт (сессия началась), что-то посмотрел, ушёл обедать,
через час вернулся, и его послеобеденная активность на сайте засчитается уже в новую сессию.
Хорошо ли это?</p>

<p>На самом деле этот получасовой тайм-аут имеет происхождение
ещё из тех доисторических времён, когда пользователь натурально
<em>выходил в интернет</em> с помощью модема, и по завершению сеанса работы (с поминутной оплатой)
отключался. Естественно, никто в здравом уме не ушёл бы на обед с
подключенным модемом и продолжающейся сессией. Получасовой тайм-аут
вполне соотносился с реальностью и соответствовал общепринятой практике
работы c интернетом.</p>

<p>Но в современном мире человек находится в онлайне всегда, и сайт может
быть открыт во вкладке браузера днями, неделями и даже месяцами: пользователь
просто будет переключаться на вкладку с сайтом в моменты, когда в этом возникает необходимость.
Эти переключения никак не связаны с &ldquo;сеансом работы в интернет&rdquo;, и тайм-аут 30 минут в современных реалиях
оказывается просто взятым с потолка. Поэтому лучше определить
тайм-аут, исходя из реальной статистики поведения людей на сайтах.</p>

<figure >
<img width="839" height="296" class="lazy" src="page_interval_lr.png"
      data-src="page_interval.png" data-srcset="page_interval@2x.png 2x">
  <figcaption><p>Распределение интервалов между просмотрами
страниц каждым посетителем сайта shop.ml. Слева отображены интервалы
от 5 минут до 2 часов, справа от 5 минут до 24 часов. Такое же распределение,
с незначительными отличиями, наблюдается и на других сайтах.</p>
</figcaption> 
</figure>

<p>На левой диаграмме видно, что точка &ldquo;30 минут&rdquo; не обладает никакими
особенными свойствами: количество интервалов плавно
падает с возрастанием размера интервала, и до, и после этой точки. На правой диаграмме
более интересная картина: начиная примерно с 8 часов интервалы между просмотрами
выходят на &ldquo;равнину&rdquo;, а ближе к 24 часам количество интервалов даже растёт.
Рост объясняется суточной цикличностью, например человек посмотрел сайт перед уходом на работу,
количество времени было ограничено, поэтому &ldquo;досматривает&rdquo; его на следующий
день примерно в то же время. Но нас больше интересует момент выхода на минимальную
вероятность интервала: разумно предположить, что 8 часов это и есть наиболее естественный тайм-аут между
сессиями. Этот тайм-аут мы и будем использовать в дальнейшем во всех моделях.</p>

<h2 id="сессии-или-переходы">Сессии или переходы?</h2>

<figure >
<img width="850" height="348" class="lazy" src="user_timelines_lr.png"
      data-src="user_timelines.png" data-srcset="user_timelines@2x.png 2x">
  <figcaption><p>&ldquo;Истории жизни&rdquo; нескольких посетителей сайта.
Цветными кружками обозначены переходы на сайт, цветными треугольниками &ndash;
достижения целей, тонкими вертикальными штрихами &ndash; просмотры страниц,
черными точками &ndash; моменты начала сессий.</p>
</figcaption> 
</figure>

<p>На диаграмме видно, что обычно переход
на сайт совпадает с началом сессии, но не всегда. Возможны сессии
без переходов, например у пользователей #11 и #17
 (вероятно, сайт висит во вкладке браузера и пользователь
время от времени переключается на него), и наоборот, возможны переходы
внутри сессий. На диаграмме переходы внутри сессий не очень хорошо различимы
 (несколько полупрозрачных кружков сливаются в один более насыщенный),
 поэтому рассмотрим подробную историю переходов одного из посетителей,
например #15:
<style>th {text-align: center;}</style></p>

<table>
<thead>
<tr>
<th align="center">Дата и время</th>
<th align="center">Тип перехода</th>
<th align="center">Номер сессии</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">2016-12-12 00:03:59</td>
<td align="center">organic</td>
<td align="center">1</td>
</tr>

<tr>
<td align="center">2016-12-17 15:18:20</td>
<td align="center">ad</td>
<td align="center">2</td>
</tr>

<tr>
<td align="center">2016-12-17 15:19:46</td>
<td align="center">direct</td>
<td align="center">2</td>
</tr>

<tr>
<td align="center">2016-12-18 00:25:05</td>
<td align="center">ad</td>
<td align="center">3</td>
</tr>

<tr>
<td align="center">2016-12-22 00:19:23</td>
<td align="center">direct</td>
<td align="center">4</td>
</tr>

<tr>
<td align="center">2016-12-22 00:20:25</td>
<td align="center">ad</td>
<td align="center">4</td>
</tr>

<tr>
<td align="center">2016-12-22 00:24:11</td>
<td align="center">ad</td>
<td align="center">4</td>
</tr>

<tr>
<td align="center">2017-01-06 00:20:07</td>
<td align="center">ad</td>
<td align="center">5</td>
</tr>

<tr>
<td align="center">2017-01-06 00:21:51</td>
<td align="center">direct</td>
<td align="center">5</td>
</tr>

<tr>
<td align="center">2017-02-13 19:13:00</td>
<td align="center">ad</td>
<td align="center">6</td>
</tr>

<tr>
<td align="center">2017-02-13 19:13:27</td>
<td align="center">ad</td>
<td align="center">6</td>
</tr>
</tbody>
</table>

<p>Видно, что в течение многих сессий совершается два или три перехода.
В среднем по всем посетителям количество переходов на 15-30% превышает количество визитов.</p>

<p>Как с этим поступают современные системы интернет аналитики? Очень просто:
каждый новый переход на сайт считается началом нового визита.
Фактически переходы приравниваются к визитам, что приводит
к тому, что у посетителей, совершающих много переходов, визиты нарезаются в мелкую лапшу.
Для систем интернет-аналитики это нормальный компромиссный подход, в противном случае
пришлось бы ввести дополнительную сущность &ldquo;переход&rdquo; и все отчёты сильно бы усложнились.</p>

<p>Но мы при построении моделей не станем упрощать действительность и честно учтём
визиты и переходы, как отдельные сущности. Границы визитов
будут определяться только таймаутом 8 часов, и ничем более.</p>

<h2 id="конструируем-признаки">Конструируем признаки</h2>

<p>Перейдем к собственно моделированию. Мы рассматриваем посетителей, которые
уже сделали хотя бы один переход на сайт, то есть у них есть история.
История содержит данные о сессиях, переходах, просмотрах страниц,
кликах на ведущие вовне ссылки, загрузках файлов и т.п. Как и в прошлой
модели, будем рассматривать посетителя в момент, когда он совершает новый
переход на сайт (только это будет уже не первый переход), и предсказывать,
произойдет ли конверсия до следующего перехода или до завершения сессии.</p>

<p>К признакам, которые уже были в предыдущей модели, добавляются новые признаки,
сконструированные по историческим данным. Пример нескольких таких признаков:</p>

<ul>
<li><strong>time_since_prev_landing</strong> &ndash; интервал времени с момента предыдущего перехода на сайт.</li>
<li><strong>time_since_sess_start</strong> &ndash; интервал времени от начала сессии до текущего перехода. Для переходов,
совпавших с началом сессии, равен нулю.</li>
<li><strong>time_since_prev_sess</strong> &ndash; интервал времени от последнего события в предыдущей сессии до
текущего перехода</li>
<li><strong>landing_num</strong> &ndash; порядковый номер текущего перехода во всей истории переходов</li>
<li><strong>sess_interval</strong> &ndash; средний интервал времени между сессиями посетителя, по данным предыдущих сессий.</li>
<li><strong>avg_sess_len</strong> &ndash; средняя продолжительность сессии посетителя, по данным предыдущих сессий.</li>
<li><strong><span style="white-space: nowrap;">$\sum$order_step<sub>n</sub></span></strong> &ndash; количество достижений цели, являющейся n-ным шагом в
конверсионной воронке, т.е. одним из этапов совершения заказа, за всю историю до текущего момента.</li>
<li><strong>user_age</strong> &ndash; &ldquo;возраст&rdquo; посетителя, т.е. промежуток времени от момента,
когда посетитель впервые зашёл на сайт, до текущего перехода.
нет смысла засчитывать это время, как активное).</li>
<li><strong><span style="white-space: nowrap;">$\sum$path<sub>1</sub>=X</span></strong>, <strong><span style="white-space: nowrap;">$\sum$path<sub>2</sub>=X</span></strong> &ndash; суммарное количество просмотров страниц в истории, соответствующих
пути <strong>X</strong> (берётся первый уровень пути для path<sub>1</sub>, первый и второй уровни для path<sub>2</sub>).
Это запись в <a href="https://ru.wikipedia.org/wiki/%D0%9D%D0%BE%D1%82%D0%B0%D1%86%D0%B8%D1%8F_%D0%90%D0%B9%D0%B2%D0%B5%D1%80%D1%81%D0%BE%D0%BD%D0%B0" target="_blank">нотации Айверсона</a>
$\sum[path_i=X]$, у которой опущены для краткости квадратные скобки.
В обобщённом виде, без указания конкретного пути, эти признаки записываются как
<strong>path1_history</strong> и <strong>path2_history</strong>.

<br /></li>
</ul>

<h2 id="все-ли-признаки-одинаково-полезны">Все ли признаки одинаково полезны?</h2>

<p>На основе истории посетителя можно сконструировать в общем то неограниченное
количество признаков, лимитом здесь является только фантазия автора модели.
Возникает логичный вопрос &ndash; в какой момент надо остановиться? Проблема в том,
что несмотря на объем данных (миллионы посетителей), в них не так много положительных
примеров совершившихся конверсий (всего несколько тысяч). В то же время
количество признаков в моделях, учитывая что у нас в основном категориальные
признаки, которые переводятся в числовые через one-hot encoding, тоже
легко переваливает за тысячу и приближается к количеству позитивных примеров.
Это означает, что наши модели потенциально подвержены <a href="https://ru.wikipedia.org/wiki/%D0%9F%D0%B5%D1%80%D0%B5%D0%BE%D0%B1%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5" target="_blank">переобучению</a>.</p>

<p>Если подать на вход модели просто шум вместо реальных признаков, всё равно в нём найдутся случайные
корреляции с целевой переменной (конверсией), модель сделает вид, что обучилась, и даже будет показывать
степень влияния &ldquo;признаков&rdquo; на результат. Но это влияние будет миражом, фейковой новостью,
и только введёт в заблуждение пользователя модели. Любой из сконструированных
нами признаков в принципе может оказаться таким шумом, и <em>ухудшить</em>
способности модели к предсказанию на новых данных. Как же определить, в каких признаках
содержится полезный сигнал, а в каких только шум?</p>

<p>Некоторые виды моделей, например деревья решений,
способны выдавать показатели &ldquo;важности&rdquo; признаков (feature importance), и обычно полезные признаки
отбирают именно по этим показателям. Но эта &ldquo;важность&rdquo; точно так же
переобучается, как и сама модель: в конечном итоге важность это
показатель того, сколько корреляций с целевой переменной обнаружила модель в
признаке. Это корреляции могут оказаться просто случайными.</p>

<p>Мы пойдём более честным, хотя и вычислительно затратным путём, и будем
использовать метод, называемый <em>Sequential Feature Selection</em>. Суть метода
простая: в начале есть набор из всех имеющихся признаков.
На каждом шаге мы убираем по очереди один из признаков, заново обучаем модель,
и смотрим, как изменится качество её работы на тестовой выборке. Если признак
был бесполезен и содержал шум, качество повысится. Если мы наоборот убрали полезный
признак, качество упадёт. По итогам исключается признак, без которого
модель работает лучше всего, и цикл начинается снова, уже с уменьшенным набором признаков.
Так признаки исключаются до тех пор, пока не останется ни одного. Признаки,
исключенные последними &ndash; самые важные; признаки, исключенные первыми &ndash; самые
бесполезные, или даже вредные.</p>

<p>Вычислительная сложность такого метода $q \times n^2/2$ циклов обучение-валидация,
 где $n$ это количество признаков, $q$ это количество разбиений в кросс-валидации. Это довольно много, поэтому
получить разумное время вычислений удалось только при использовании нескольких GPU.</p>

<p>Ниже представлены результаты для одного сайта (часть признаков скрыта):
<figure >
<img width="854" height="401" class="lazy" src="luxshop_sfs_lr.png"
      data-src="luxshop_sfs.png" data-srcset="luxshop_sfs@2x.png 2x">
  <figcaption><p>Результат работы полного цикла Sequential feature selection.
В основном доминируют признаки, относящиеся к адресам просмотренных страниц,
на их фоне роль других признаков слабо различима.</p>
</figcaption> 
</figure></p>

<figure >
<img width="851" height="401" class="lazy" src="luxshop_sfs_cut_lr.png"
      data-src="luxshop_sfs_cut.png" data-srcset="luxshop_sfs_cut@2x.png 2x">
  <figcaption><p>Отдельно &ldquo;маловажные&rdquo; признаки. Видно, как ошибка модели (logloss)
сначала падает, потом начинает расти.</p>
</figcaption> 
</figure>

<p>Признаки, удаление которых привело к улучшению работы модели (т.е. вредные), показаны
красным; признаки, удаление которых привело к улучшению (полезные) показаны
зелёным; нейтральные &ndash; серым.</p>

<p>По результатам feature selection для каждого сайта
были отброшены признаки из красной зоны и часть признаков из серой.</p>

<h2 id="модель-для-luxshop-ml-результаты">Модель для luxshop.ml, результаты</h2>

<p>Проверка обученной модели на тестовой выборке дала AUC около 86%,
что очень неплохо для предсказаний действий посетителей, ведущих
себя в общем то случайным образом. AUC заметно вырос по сравнению
с предыдущей моделью по первому переходу на сайт (было ~75%), потому что
появилось много дополнительной информации из истории посетителя.</p>

<p>В предыдущих моделях все используемые признаки были категорийными,
и мы измеряли только влияние наличия признака, т.е. да/нет. В новых моделях
многие признаки это числовые значения, например время с момента
последнего перехода может быть любым числом от нуля до $\approx3.2 \times 10^7$ (количество секунд в году),
поэтому поход к интерпретации влияния признаков будет другим.</p>

<p>Для начала визуализируем признаки, обладающие наибольшим абсолютным
влиянием на модель:</p>

<figure >
<img width="641" height="694" class="lazy" src="top_absshap_luxhop_lr.png"
      data-src="top_absshap_luxhop.png" data-srcset="top_absshap_luxhop@2x.png 2x">
  
</figure>

<p>Это довольно сложная визуализация, требующая пояснений.
Цвет объекта на диаграмме соответствует числовому значению
признака. Минимальным значениям (в нашем случае это обычно ноль) соответствуют голубые цвета,
максимальным значениям &ndash; красные, промежуточным значениям &ndash; оттенки синего, фиолетового и пурпурного.
Диапазон от минимальных до максимальных значений индивидуален для каждого признака,
например у бинарных признаков (таких как <strong>regionCity=RussiaMoscow</strong>) всего два значения, <strong>0</strong> и <strong>1</strong>,
и, соответственно,
всего два цвета, красный и голубой.</p>

<p>Значение некоторых признаков равно ∅. Этим символом обозначается отсутствие
логического значения, например <strong>lastSearchEngine=∅</strong>, если переход совершался не из поисковой
машины, или <strong>path<sub>2</sub>=∅</strong>, если в URL перехода был только первый уровень,
например <code>/</code> или <code>/catalog</code>. Можно интерпретировать символ ∅, как &ldquo;дырка от бублика&rdquo;.</p>

<p>Каждый признак представлен набором точек: одна точка это один пример
из тестовой выборки. Точек много, поэтому они сливаются в вытянутые по горизонтали облака.
Координата точки по оси X соответствует степени влияния признака на результат.
Вдоль диаграммы проходит вертикальная нулевая ось (серая линия),
чем точка правее от этой оси, тем больше признак действует &ldquo;в плюс&rdquo;, чем левее,
тем больше &ldquo;в минус&rdquo;. Размер этого влияния есть на шкале внизу диаграммы.</p>

<p>Чтобы облако точек для каждого признака не превратилось в горизонтальную линию,
точки случайным образом разбросаны немного вверх и вниз от горизонтальной оси,
соответствующей признаку. Чем больше точек уложено на отрезке оси, тем толще получается
в этом месте облако после &ldquo;разброса&rdquo;. Например, если облако толще всего в околонулевых
координатах по оси X, это означает, что для большинства примеров этот
признак оказывает околонулевое воздействие на результат.</p>

<p>Чтобы стало понятнее, рассмотрим несколько топовых признаков по отдельности.</p>

<h3 id="hahahugoshortcode-0xc001388a00-9-hbhb"><span style="white-space: nowrap;">$\sum$path<sub>1</sub>=/basket/</span></h3>

<figure style="margin-top: 0; margin-bottom: 0">
<img width="407" height="79" class="lazy" src="single_f_0_lr.png"
      data-src="single_f_0.png" data-srcset="single_f_0@2x.png 2x">
  
</figure>

<p>Количество просмотров страниц в истории, URL которых начинался с <code>/basket/</code>.
Нулевые значения (голубое облако слева) оказывают отрицательное воздействие,
положительные (вытянутая красно-фиолетовая линия справа) &ndash; сильно положительное.
Степень положительного воздействия значительно отличается от примера к примеру
 (большая дисперсия, вытянутая линия вместо облака). Эти же значения
 можно отобразить на развёрнутой диаграмме:
<figure style="margin-top: 32px; margin-bottom: 32px">
<img width="468" height="332" class="lazy" src="path1_basket_luxshop_lr.png"
      data-src="path1_basket_luxshop.png" data-srcset="path1_basket_luxshop@2x.png 2x">
  
</figure></p>

<p>Эта диаграмма тоже требует пояснений. По оси X &ndash; значения нашего признака,
в логарифмической шкале (от 0 до примерно 300). По оси Y &ndash; соответствующее воздействие на результат модели.
Каждая точка это один пример из тестовой выборки. Значения немного &ldquo;разбросаны&rdquo; по оси X
 для лучшей визуализации, в противном случае например все значения, где
X=0, выстроились бы в узкую вертикальную полоску, на которой сложно было
бы разглядеть детали. Чем ближе значение к нулю, тем больше
&ldquo;разброс&rdquo;.</p>

<p>Окраска точек отличается от окраски на мини-графике. Цвет каждой точки
соответствует значению второго признака, в данном случае второй признак
это <strong>UTMMedium=∅</strong>. Символ ∅, напомню, обозначает &ldquo;пустоту&rdquo;, т.е. если в URL
перехода на сайт не было метки <strong>UTMMedium</strong>, значение признака <strong>UTMMedium=∅</strong> равно единице,
а если метка была, значение равно нулю. Но какое отношение
<strong>UTMMedium</strong> имеет к признаку <strong><span style="white-space: nowrap;">$\sum$path<sub>1</sub>=/basket/</span></strong>, зачем нам
вообще второй признак?</p>

<p>Дело в том, что мы используем достаточно сложные модели, в которых большую
роль играет взаимодействие признаков (feature interaction). Другими словами,
влияние, которое оказывает на результат работы модели один признак, может зависеть
не только от значения самого этого признака, но и от значений других признаков,
<em>взаимодействующих</em> с первым. Визуализировать такое множественное взаимодействие
непросто, поэтому применяется упрощённый подход: берётся единственный признак, который
более всего взаимодействует с основным, и его значения
используются, как палитра для раскраски точек. Соответствие цветов значениям
вторичного признака отображается на вертикальной цветной полоске справа.
В данном случае у нас бинарный признак, 0 или 1, поэтому на полоске
всего два цвета, нулю соответствует голубой, а единице &ndash; красный.</p>

<p>Итак, что же мы видим на подробной диаграмме?</p>

<p>Если в истории посетителя не было ни одного захода на страницы, связанные
с корзиной, т.е. значение признака <strong><span style="white-space: nowrap;">$\sum$path<sub>1</sub>=/basket/</span></strong> равно нулю,
вероятность конверсии понижается примерно на 0.5 единиц. При этом, если
в URL перехода на сайт нет метки <strong>UTMMedium</strong>, негативное влияние
нулевого значения основного признака ослабляется: мы видим, что верх левого &ldquo;столбика&rdquo;
на графике окрашен в красный цвет, а низ &ndash; в синий. Красный соответствует
единичному значению вторичного признака, т.е. &ldquo;метки нет&rdquo;, а синий - наоборот,
&ldquo;метка есть&rdquo;.</p>

<p>Если в истории был хотя бы один заход на страницу, относящуюся к корзине,
вероятность конверсии сразу резко возрастает (для всех значений X &gt; 0 вероятность
повышается на 1-2 единицы). При этом значение вторичного признака уже не играет роли:
красные и синие точки в &ldquo;ненулевой&rdquo; части графика перемешаны более-менее равномерно.</p>

<p>При повышении значения признака, положительное влияние растёт, т.е. чем
чаще посетитель заходил в корзину, тем выше вероятность конверсии;
при более чем 100 заходах положительное влияние может достигать трёх единиц.</p>

<p>Вот такое длинное описание потребовалось, чтобы расшифровать такую
маленькую диаграмму 😌 Но мы теперь умеем интерпретировать такие диаграммы,
и следующие описания будут короче.</p>

<h3 id="regioncity-russiamoscow">regionCity=RussiaMoscow</h3>

<figure style="margin-top: 0; margin-bottom: 0">
<img width="407" height="79" class="lazy" src="single_f_1_lr.png"
      data-src="single_f_1.png" data-srcset="single_f_1@2x.png 2x">
  
</figure>

<p>Это бинарный признак, интерпретация очень простая: положительные значения
(посетитель из Москвы, красное облако справа) повышают конверсию, отрицательные (не из Москвы, голубое облако слева)
&ndash; понижают.
<figure >
<img width="463" height="321" class="lazy" src="regioncity_moscow_luxshop_lr.png"
      data-src="regioncity_moscow_luxshop.png" data-srcset="regioncity_moscow_luxshop@2x.png 2x">
  
</figure></p>

<p>Заметно любопытное взаимодействие: если посетитель перешёл из поисковика
(нулевое значение <strong>lastAdvEngine=∅</strong>, голубая окраска точек),
влияние Москвы, как отрицательное, так и положительное, снижается.</p>

<h3 id="time-since-prev-sess">time_since_prev_sess</h3>

<figure style="margin-top: 0; margin-bottom: 0">
<img width="407" height="79" class="lazy" src="single_f_5_lr.png"
      data-src="single_f_5.png" data-srcset="single_f_5@2x.png 2x">
  
</figure>

<p>По мини-графику сложно сказать что-то конкретное, кроме того, что в большинстве случаев
воздействие на конверсию околонулевое или слабо отрицательное (по положению утолщений).
<figure >
<img width="463" height="321" class="lazy" src="time_since_prev_sess_luxshop_lr.png"
      data-src="time_since_prev_sess_luxshop.png" data-srcset="time_since_prev_sess_luxshop@2x.png 2x">
  
</figure></p>

<p>Виден большой разрыв в значениях, вызванный 8-часовым тайм-аутом сессии.
Если переход происходит в рамках первой сессии, время от предыдущей сессии
принимается равным нулю, в противном случае время от конца предыдущей
сессии будет как минимум 8 часов.</p>

<p>Переход в первой сессии несколько снижает вероятность конверсии.
Для переходов, совершённых в следующих сессиях, зависимость очень любопытна:
есть &ldquo;хорошее&rdquo; время, примерно в течение недели после сессии, и &ldquo;плохое&rdquo;,
от недели до двух месяцев. По видимому, в течение первой недели посетитель
ещё &ldquo;горячий&rdquo;, с твёрдым намерением сделать покупку, а потом &ldquo;остывает&rdquo;
и заходит на сайт просто посмотреть на товары, не собираясь их
приобретать, или просто помимо своей воли перекидывается на сайт рекламными
системами.</p>

<p>Прослеживается также интересное взаимодействие со вторым признаком.</p>

<h3 id="hahahugoshortcode-0xc001388a00-18-hbhb"><span style="white-space: nowrap;">$\sum$path<sub>2</sub>=∅</span></h3>

<p>Это значение признака интерпретируется, как
количество раз, когда посетитель заходил на &ldquo;топовые&rdquo; страницы
сайта, не опускаясь вглубь, на второй уровень.
<figure style="margin-top: 0; margin-bottom: 0">
<img width="407" height="79" class="lazy" src="single_f_7_lr.png"
      data-src="single_f_7.png" data-srcset="single_f_7@2x.png 2x">
  
</figure></p>

<p>По мини-графику можно предположить, что большие значения признака имеют
в среднем нулевой эффект (красные точки сконцентрированы около нуля),
а околонулевые и близкие к ним значения могут проявлять
как положительное, так и отрицательное воздействие на конверсию. Также
в большинстве случаев воздействие признака на конверсию равно нулю или
 чуть больше нуля (есть утолщение в районе нуля).
<figure >
<img width="468" height="332" class="lazy" src="sum_path2_none_luxshop_lr.png"
      data-src="sum_path2_none_luxshop.png" data-srcset="sum_path2_none_luxshop@2x.png 2x">
  
</figure></p>

<p>Развёрнутая диаграмма подтверждает наше предположение:
Нулевое значение отрицательно действует на конверсию, единичное -
максимально действует в &ldquo;плюс&rdquo;, и по мере увеличения значений признака
воздействие уменьшается и становится снова отрицательным.</p>

<p>Также любопытно взаимодействие со вторым признаком: messenger, как UTM
источник, сильно увеличивает негативное воздействие для нулевого значения
основного признака.</p>

<p>Дальше будем рассматривать только развёрнутые диаграммы, т.к. дано
уже достаточно примеров интерпретации мини-графиков.</p>

<h3 id="hahahugoshortcode-0xc001388a00-21-hbhb"><span style="white-space: nowrap;">$\sum$pageview_duration</span></h3>

<figure >
<img width="468" height="329" class="lazy" src="sum_pageview_duration_luxshop_lr.png"
      data-src="sum_pageview_duration_luxshop.png" data-srcset="sum_pageview_duration_luxshop@2x.png 2x">
  
</figure>

<p>Хороший посетитель просматривал сайт достаточное время, но не слишком долго,
оптимальное время от 10 минут до нескольких часов. Посетители, которые разглядывали
сайт магазина более 6 часов, видимо используют его, просто как источник
для вдохновения.</p>

<h3 id="hahahugoshortcode-0xc001388a00-23-hbhb"><span style="white-space: nowrap;">$\sum$path<sub>1</sub>=/delivery/</span></h3>

<figure >
<img width="464" height="332" class="lazy" src="sum_path1_delivery_luxshop_lr.png"
      data-src="sum_path1_delivery_luxshop.png" data-srcset="sum_path1_delivery_luxshop@2x.png 2x">
  
</figure>

<p>Идеальный посетитель интересуется доставкой дважды. Лучше, если это происходит
в первой или второй сессии. Для посетителей, интересовавшихся доставкой
более 7 раз, есть подозрение на проблемы с памятью: возможно, делать
покупки они тоже забывают.</p>

<h3 id="landing-num">landing_num</h3>

<figure >
<img width="471" height="323" class="lazy" src="landing_num_luxshop_lr.png"
      data-src="landing_num_luxshop.png" data-srcset="landing_num_luxshop@2x.png 2x">
  
</figure>

<p>Принято считать, что чем чаще посетитель заходит в магазин, тем
выше его лояльность, и тем лучший он покупатель. Но эта диаграмма
показывает прямо обратное. Забегая вперёд, скажу, что похожая
зависимость наблюдается и на других сайтах, т.е. это не случайное
статистическое отклонение и не особенность этой модели. Причины
такой зависимости будут более подробно разобраны позже, на примере сайта
shop.ml.</p>

<h3 id="time-since-sess-start">time_since_sess_start</h3>

<figure >
<img width="479" height="320" class="lazy" src="time_since_sess_start_luxshop_lr.png"
      data-src="time_since_sess_start_luxshop.png" data-srcset="time_since_sess_start_luxshop@2x.png 2x">
  
</figure>

<p>Модель показывает, что посетителю в идеале нужен примерно час от начала сессии,
чтобы дозреть до решения о покупке.</p>

<h3 id="user-age">user_age</h3>

<figure >
<img width="463" height="321" class="lazy" src="user_age_luxshop_lr.png"
      data-src="user_age_luxshop.png" data-srcset="user_age_luxshop@2x.png 2x">
  
</figure>

<p>Как и в случае с <strong>landing_num</strong>, здесь не наблюдается однозначного повышения
&ldquo;качества&rdquo; посетителей с увеличением времени их знакомства с магазином.
Наоборот вероятность конверсии с возрастом падает, и только у &ldquo;старой гвардии&rdquo;
возрастом более 120 дней опять начинает повышается.
$$\DeclareMathOperator{\E}{E}$$</p>

<h2 id="ранжирование-по-среднему-воздействию-признака">Ранжирование по среднему воздействию признака</h2>

<p>До этого момента мы ранжировали признаки по силе их абсолютного воздействия,
то есть по $\sum_n|S_i|$, где $S_i$ это SHAP value i-го признака, $n$ &ndash;
количество примеров в тестовой выборке. Но можно отранжировать признаки
и по матожиданию $\E[S_i]$, как мы делали это в предыдущей статье,
и построить соответствующую диаграмму. Тогда в топ выйдут признаки, которые
в среднем влияют максимально положительно или максимально отрицательно:
<figure >
<img width="520" height="737" class="lazy" src="luxshop_top_pos_neg_lr.png"
      data-src="luxshop_top_pos_neg.png" data-srcset="luxshop_top_pos_neg@2x.png 2x">
  
</figure></p>

<p>Всю верхушку положительного топа оккупировал признак <strong><span style="white-space: nowrap;">$\sum$path<sub>1</sub>=/basket/</span></strong>, это
соответствует тому, что мы уже видели на диаграммах. Этот же признак, но
с нулевым значением &ndash; второй по негативному воздействию. Также в топе
неожиданно засветился признак <strong>path<sub>1</sub>=/404</strong>, скорее всего
соответствующий адресу страницы с ошибкой <code>404 Page not found</code>.
Можно предположить, что такая ошибка выдавалась посетителям, у которых было
твёрдое намерение приобрести определённый товар, исчезнувший из ассортимента
магазина, и они всё равно делали заказ, приобретая замену.</p>

<h2 id="user-scorecards">User scorecards</h2>

<p>Из рассмотренных примеров видно, что интерпретация воздействия признаков
в продвинутой модели это не такая простая задача. Все диаграммы, которые мы построили,
не охватывают думаю и нескольких процентов возможных кейсов по воздействию
на конверсию и особенно по взаимодействию признаков друг с другом.</p>

<p>Поэтому для продвинутых моделей особенно хороши <em>user scorecards</em>, которые
позволяют без построения гипотез и абстрактных рассуждений просто взять и увидеть,
как конкретные значения признаков влияют на вероятность конверсии конкретного посетителя сайта.
<figure >
<img width="612" height="734" class="lazy" src="luxshop_scorecards_lr.png"
      data-src="luxshop_scorecards.png" data-srcset="luxshop_scorecards@2x.png 2x">
  
</figure></p>

<p>Напомню, черная горизонтальная черта это то, насколько вероятность
конверсии данного посетителя отличается от средней по сайту (средней конверсии
соответствует горизонтальная пунктирная линия, идущая из нулевой точки); красные столбцы
над этой чертой &ndash; положительно влияющие признаки, размер каждого
столбца равен силе влияния признака; синие столбцы под чертой &ndash; признаки
с отрицательным влиянием.</p>

<p>Видно, что на конверсию каждого посетителя влияет большое количество признаков,
их даже не получилось все детализировать на диаграмме
(розовая и светло-голубая &ldquo;шапки&rdquo; сверху и снизу у каждого посетителя)</p>

<h1 id="результаты-для-shop-ml">Результаты для shop.ml</h1>

<p>Пр проверке модели на тестовой выборке получен AUC 84%. Посмотрим,
что есть интересного в признаках:
<figure >
<img width="638" height="687" class="lazy" src="top_absshap_shopml_lr.png"
      data-src="top_absshap_shopml.png" data-srcset="top_absshap_shopml@2x.png 2x">
  
</figure></p>

<p>Прежде всего, отметим сильное влияние признака <strong><span style="white-space: nowrap;">$\sum$path<sub>1</sub>=/cart/</span></strong>.
<figure >
<img width="460" height="331" class="lazy" src="sum_path1_shop_lr.png"
      data-src="sum_path1_shop.png" data-srcset="sum_path1_shop@2x.png 2x">
  
</figure></p>

<p>Уже единственный заход на страницу, связанную с корзиной, поднимает
вероятность конверсии на полпункта, а три захода &ndash; на целый пункт (напомню,
один пункт это изменение вероятности конверсии примерно в два раза).
Ни один другой признак не влияет так сильно.</p>

<p>Cильное влияние и у признака  <strong><span style="white-space: nowrap;">$\sum$path<sub>2</sub>=/cart/done</span></strong>,
также в топе есть <strong><span style="white-space: nowrap;">$\sum$path<sub>2</sub>=/cart/laststep</span></strong> и <strong><span style="white-space: nowrap;">$\sum$path<sub>1</sub>=/delivery/</span></strong>. Похоже, что работа
с корзиной и доставкой является критически важным фактором в оценке посетителя.</p>

<p>Теперь посмотрим на признаки с выраженным отрицательным влиянием. Здесь нас
ждёт сюрприз.
<figure >
<img width="471" height="323" class="lazy" src="landing_num_shop_lr.png"
      data-src="landing_num_shop.png" data-srcset="landing_num_shop@2x.png 2x">
  
</figure></p>

<p>Признак с самым явно выраженным негативным влиянием это <strong>landing_num</strong>, порядковый номер захода на сайт.
Про росте значения признака конверсионность посетителя резко падает.
Казалось бы, должно быть наоборот: чем чаще человек пользуется сайтом,
тем более это лояльный покупатель?
<figure >
<img width="476" height="331" class="lazy" src="sum_utmc_shop_lr.png"
      data-src="sum_utmc_shop.png" data-srcset="sum_utmc_shop@2x.png 2x">
  
</figure></p>

<p>Схожим образом работает признак <strong><span style="white-space: nowrap;">$\sum$UTMCampaign=∅</span></strong> и близкие к нему
по смыслу признаки <strong><span style="white-space: nowrap;">$\sum$referer=∅</span></strong> и <strong><span style="white-space: nowrap;">$\sum$lastSocialNetwork=∅</span></strong>.
<figure >
<img width="479" height="323" class="lazy" src="user_age_shop_lr.png"
      data-src="user_age_shop.png" data-srcset="user_age_shop@2x.png 2x">
  
</figure></p>

<p>При увеличении &ldquo;возраста&rdquo; посетителя его конверсионность тоже падает.
Что же происходит с посетителями, у них постепенно вырабатывается
отвращение к покупкам?</p>

<p>На самом деле нет. В данных сайта shop.ml заметно, что часть трафика
приходит из довольно сомнительных источников. Представим источник,
перекидывающий людей на сайт через popunder, clickunder или другим не слишком
цивилизованным способом. У посетителей из таких источников будет
много переходов, но так как они не собираются ничего покупать, они не
будут работать с корзиной. Таких посетителей много: из всех
посетителей, совершивших более 10 переходов на сайт shop.ml, меньше
трети когда либо пользовались корзиной.</p>

<p>Но если посетитель совершает переходы и не работает с корзиной, значит
это мусорный трафик, и модели надо научиться его распознавать? Да, и именно
поэтому у признаков <strong>landing_num</strong>, <strong>user_age</strong> и признаков, связанными с пустыми
<em>UTMCampaign / referer / socialNetwork</em>,
наблюдается негативное влияние. Как только посетитель воспользуется корзиной,
весь негатив от этих признаков сразу будет скомпенсирован
сильным положительным влиянием признака <strong><span style="white-space: nowrap;">$\sum$path<sub>1</sub>=/cart/</span></strong>.
Ну а пока посетитель набирает переходы на сайт и не использует корзину,
априори считаем его низкокачественным трафиком &ndash; вполне разумно.</p>

<p>В подтверждение этой версии, на диаграммах заметно взаимодействие
признака <strong><span style="white-space: nowrap;">$\sum$path<sub>1</sub>=/cart/</span></strong> и генерирующих негатив
признаков <strong>landing_num</strong> и  <strong><span style="white-space: nowrap;">$\sum$UTMCampaign=∅</span></strong>: работа с корзиной
снижает степень негатива.</p>

<p>Взаимную компенсацию признаков видно и на scorecards:
<figure >
<img width="612" height="734" class="lazy" src="shopml_scorecards_lr.png"
      data-src="shopml_scorecards.png" data-srcset="shopml_scorecards@2x.png 2x">
  
</figure></p>

<p>У посетителя <strong>A</strong> присутствует весь набор негативных признаков, тем
не менее у него повышенная более чем на 2.5 пункта вероятность конверсии,
потому что есть работа с корзиной. У посетителя <strong>B</strong> негативные признаки
выражены не так явно, но прогноз конверсии в целом негативен, т.к. заходов в корзину не было.</p>

<p>Итак, фактически у нас получилась модель оценки качества трафика,
использующая конверсионность, как метрику качества. Неплохо, не правда ли?</p>

<h1 id="результаты-для-courses-ml">Результаты для courses.ml</h1>

<p>Для этого сайта не существует цели &ldquo;заказ&rdquo;, поэтому сделаем синтетическую
цель, соответствующую бизнес-задачам сайта. Сайт существует, чтобы обучать,
поэтому конверсию будем засчитывать, если посетитель продержался
на сайте ещё как минимум полчаса после перехода. Будем считать, что в эти
полчаса он обучался, а не просто рассматривал картинки.</p>

<p>Суммарное влияние признаков:
<figure >
<img width="637" height="578" class="lazy" src="top_absshap_courses_lr.png"
      data-src="top_absshap_courses.png" data-srcset="top_absshap_courses@2x.png 2x">
  
</figure></p>

<h3 id="hahahugoshortcode-0xc001388a00-48-hbhb"><span style="white-space: nowrap;">$\sum$pageview_duration</span></h3>

<p>Более всего на результат влияет суммарное время просмотра страниц, т.е.
модель предполагает, что если посетитель уже потратил заметное количество времени на обучение,
он будет продолжать обучаться дальше.
<figure >
<img width="468" height="328" class="lazy" src="sum_pageview_duration_courses_lr.png"
      data-src="sum_pageview_duration_courses.png" data-srcset="sum_pageview_duration_courses@2x.png 2x">
  
</figure></p>

<p>На детальной диаграмме зависимость выражена очень явно.</p>

<h3 id="time-since-prev-sess-1">time_since_prev_sess</h3>

<figure >
<img width="480" height="320" class="lazy" src="time_since_prev_sess_courses_lr.png"
      data-src="time_since_prev_sess_courses.png" data-srcset="time_since_prev_sess_courses@2x.png 2x">
  
</figure>

<p>Прослеживается интересная форма зависимости, похожая на синусоиду. Рассмотрим
этот участок поближе, и в линейной шкале по оси X:
<figure >
<img width="480" height="320" class="lazy" src="time_since_prev_sess_courses_cut_lr.png"
      data-src="time_since_prev_sess_courses_cut.png" data-srcset="time_since_prev_sess_courses_cut@2x.png 2x">
  
</figure></p>

<p>Действительно синусоида! Наша модель самостоятельно вывела такую сложную
зависимость из входных данных, которые в общем то не предполагали
никакой периодичности. Но какова причина появления этой синусоиды?</p>

<p>Люди серьезно занимающиеся самообучением, обычно проходят курс по вечерам после работы
или после домашних дел. Или по утрам: конкретное время неважно, главное, что
обучение происходит примерно в одно и то же время каждый день.
В течение для есть довольно узкий интервал времени, в течение которого человек может сесть за обучение
и по настоящему в него погрузиться. Если начать слишком рано, скорее всего
найдутся другие занятия: работа, дом, дети, и т.п. Если начать слишком поздно,
то просто пора будет спать. То есть, если с момента завершения предыдущей
сессии обучения прошло менее 12 часов или более 22-24 часов, то новая сессия
скорее всего получится неудачной или вовсе не начнётся. Примерно это мы и видим на диаграмме.</p>

<p>Синусоида с периодом в сутки образуется, потому что не принципиально, когда закончилась предыдущая
сессия: вчера, позавчера, или три дня назад. Всё равно начало следующей сессии
наиболее вероятно только в определённом интервале времени.</p>

<p>Почему максимум вероятности приходится не ровно на 24 часа с момента предыдущей сессии?
Потому что время отсчитывается от конца предыдущей сессии, а не от начала. Сессии
имеют достаточно большую длительность, она отображена справа на шкале взаимодействующего
признака <strong>avg_sess_len</strong>. Размерность шкалы &ndash; секунды. Для понимания
масштаба: 5 часов это 18000 секунд. Там же видно, что наибольший &ldquo;размах&rdquo;
синусоиды наблюдается у посетителей с длинными сессиями. Если сеансы обучения
короткие, то обучаться можно в принципе в любое время дня, и роль суточной
периодичности снижается.</p>

<h3 id="sess-num">sess_num</h3>

<figure >
<img width="494" height="322" class="lazy" src="sess_num_courses_lr.png"
      data-src="sess_num_courses.png" data-srcset="sess_num_courses@2x.png 2x">
  
</figure>

<p>Онлайн обучение это занятие для достаточно терпеливых и упорных людей.
Терпения и упорства не всем хватает надолго. После четвёртой сессии
видно отрицательное влияние растущего номера сессии: известно, что онлайн
курсы проходит до конца только небольшой процент начавших обучение.
Кроме того, для усидчивых посетителей будет наблюдаться компенсационный
эффект от растущего <strong><span style="white-space: nowrap;">$\sum$pageview_duration</span></strong> (он виден и по взаимодействию признаков), а большие
значения <strong>sess_num</strong> могут использоваться моделью для определения случайных
переходов на сайт &ndash; аналогично механизму, описанному для сайта shop.ml.</p>

<h3 id="time-since-sess-start-1">time_since_sess_start</h3>

<figure >
<img width="463" height="320" class="lazy" src="time_since_sess_start_courses_lr.png"
      data-src="time_since_sess_start_courses.png" data-srcset="time_since_sess_start_courses@2x.png 2x">
  
</figure>

<p>Для переходов, которые не совпали с началом сессии, модель вероятно рассуждает
так: если посетитель просидел на сайте больше 10 минут, то скорее всего
просидит и ещё полчаса. А вот если время с начала сессии приближается к 6 часам,
то пора бы уже и закругляться!</p>

<h3 id="time-since-prev-landing">time_since_prev_landing</h3>

<figure >
<img width="480" height="320" class="lazy" src="time_since_prev_landing_courses_lr.png"
      data-src="time_since_prev_landing_courses.png" data-srcset="time_since_prev_landing_courses@2x.png 2x">
  
</figure>

<p>Синусоида, аналогичная <strong>time_since_prev_sess</strong>, но максимумы приходятся
уже ровно на 24 часа, т.к. нет поправки на продолжительность сессии.</p>

<h2 id="дополнительные-визуализации">Дополнительные визуализации</h2>

<figure >
<img width="507" height="659" class="lazy" src="courses_top_pos_neg_lr.png"
      data-src="courses_top_pos_neg.png" data-srcset="courses_top_pos_neg@2x.png 2x">
  
</figure>

<p>Эта визуализация представляет собой взгляд с альтернативной точки зрения, выявляющий
несколько другие признаки. На что можно обратить внимание:</p>

<ul>
<li><strong>path<sub>1</sub>=/unsubscribe/</strong> резко понижает вероятность продолжения сессии. Неудивительно.<br /></li>
<li><strong><span style="white-space: nowrap;">$\sum$path<sub>2</sub>=/lesson/J</span></strong> &ndash; по видимому очень неудачный курс:
единственного захода на эту страницу достаточно, чтобы посетитель перестал надолго задерживаться на сайте.</li>
<li><strong><span style="white-space: nowrap;">$\sum$linkUrl=<a href="https://vk.com/courses" target="_blank">https://vk.com/courses</a></span> &gt; 8</strong> &ndash; вероятно, на эту
ссылку кликают посетители, которые не удовлетворены имеющимися на сайте курсами.</li>
<li><strong><span style="white-space: nowrap;">$\sum$lastTrafficSource=saved &gt; 2</span></strong> &ndash; посетители, которые сохранили
страничку сайта себе на компьютер, и переходят с неё на сайт,
явно заинтересованы в продолжительном обучении.</li>
</ul>

<p>И, в дополнение, образцы scorecards для пары &ldquo;хороших&rdquo; и пары &ldquo;плохих&rdquo;
посетителей:
<figure >
<img width="604" height="625" class="lazy" src="courses_scorecards_lr.png"
      data-src="courses_scorecards.png" data-srcset="courses_scorecards@2x.png 2x">
  
</figure></p>

<h1 id="заключение">Заключение</h1>

<blockquote>
<p>&hellip;We have so much data on the web, almost all of it available for free,
that we dive into the the data ocean hoping that magically awesome
things will follow. They never do.</p>

<p>Avinash Kaushik.</p>
</blockquote>

<p>Основная проблема интернет-аналитики, на мой взгляд, в том, что в ней физически огромное количество
данных, но эти данные приносят удивительно мало пользы своим обладателям.</p>

<p>Почему? Потому что это не самые удобные для обработки данные, у них сложная структура,
это sparse categorical multivariate time series &ndash; подобные типы данных мейнстримовая
Machine Learning (а сейчас и AI) индустрия традиционно обходит стороной.
Ведь гораздо эффективнее впечатлять инвесторов распознаванием
изображений, генерацией музыки или чат-ботами, чем копанием в каких то там логах сессий 🙊</p>

<p>Отчасти поэтому традиционные инструменты интернет аналитики
застряли на примитивном уровне и не способны извлечь из данных даже
малую часть содержащейся в них полезной информации. За время работы с
моделями, описанными в этой статье, я, честно говоря,
узнал о поведении посетителей сайтов намного больше, чем за пару лет работы
над <a href="https://metrika.yandex.ru/promo/webvisor/" target="_blank">WebVisor</a>
и несколько лет работы в <a href="https://metrika.yandex.ru" target="_blank">Яндекс.Метрике</a>.</p>

<p>Хочется верить, что разумное применение технологий машинного обучения и AI
поможет наконец раскрыть потенциал океана данных интернет-аналитики,
и что &ldquo;awesome things&rdquo; действительно &ldquo;will follow&rdquo;.</p>

    </div>

    


<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/conversion/">Conversion</a>
  
</div>



    






<div class="media author-card" itemscope itemtype="http://schema.org/Person">
  
  <img class="portrait mr-3" src="/img/me_sq.jpg" itemprop="image" alt="Avatar">
  
  <div class="media-body">
    <h5 class="card-title" itemprop="name"><a href="/">Артур Суилин</a></h5>
    <h6 class="card-subtitle">Chief Data Scientist</h6>
    
    <ul class="network-icon" aria-hidden="true">
      
      
      
      
      
      
      <li>
        <a itemprop="sameAs" href="//www.linkedin.com/in/suilin-arthur-304b8219/" target="_blank" rel="noopener">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
      
      
      
      
      
      
      <li>
        <a itemprop="sameAs" href="//github.com/Arturus" target="_blank" rel="noopener">
          <i class="fab fa-github"></i>
        </a>
      </li>
      
      
      
      
      
      
      <li>
        <a itemprop="sameAs" href="//www.kaggle.com/asuilin" target="_blank" rel="noopener">
          <i class="fab fa-kaggle"></i>
        </a>
      </li>
      
      
      
      
      
      
      <li>
        <a itemprop="sameAs" href="//instagram.com/asuilin" target="_blank" rel="noopener">
          <i class="fab fa-instagram"></i>
        </a>
      </li>
      
    </ul>
  </div>
</div>




    
    
    <div class="article-widget">
      <div class="hr-light"></div>
      <h3>Related</h3>
      <ul>
        
        <li><a href="/post/conversion_factors/">Конверсия и data science III. Как отличить хорошее от плохого?</a></li>
        
        <li><a href="/post/conversion_opt/">Конверсия и data science II. Оптимизируем неизвестность</a></li>
        
        <li><a href="/post/conversion_numbers/">Конверсия и data science I. Как увидеть невидимое.</a></li>
        
      </ul>
    </div>
    

    
    <div class="article-widget">
      <div class="post-nav">
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="https://suilin.ru/post/clv/" rel="next">Конверсия и data science V. А сколько корова даёт молока?</a>
  </div>
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="https://suilin.ru/post/conversion_factors/" rel="prev">Конверсия и data science III. Как отличить хорошее от плохого?</a>
  </div>
  
</div>

    </div>
    

    


  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <p class="powered-by">
    &copy; 2018 &middot; Артур Суилин &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    
    
    
    <script src="/js/mathjax-config.500a6cbb2c0f345fcecc21b3116d6637aa78f1f11db8081ea581abe05390c2e8f3bbffe61be3cf0217baf785c40efceabe51050a4f007e69af94efd3643260e8.js" integrity="sha512-UApsuywPNF/OzCGzEW1mN6p48fEduAgepYGr4FOQwujzu//mG&#43;PPAhe694XEDvzqvlEFCk8AfmmvlO/TZDJg6A=="></script>
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
        
      

      
      
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML-full" integrity="sha256-GhM+5JHb6QUzOQPXSJLEWP7R73CbkisjzK5Eyij4U9w=" crossorigin="anonymous" async></script>
      
    

    <script src="/js/hugo-academic.js"></script>
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    

    
    

    

    
    

    
    
    <script>
      
      window.lazyLoadOptions = {elements_selector: ".lazy"};
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/intersection-observer@0.5.1/intersection-observer.js"></script>
    <script async src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@11.0.5/dist/lazyload.min.js"></script>

  </body>
</html>

